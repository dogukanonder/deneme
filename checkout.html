<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS Shop - Ödeme</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
     <!-- Header -->
     <header>
        <div class="container">
            <div class="header-top">
                <a href="index.html" class="logo" id="logo">
                    <i class="fas fa-shopping-bag"></i>
                    DS Shop
                </a>
                <div class="search-bar">
                    <input type="text" placeholder="Ürün ara...">
                    <button id="search-btn"><i class="fas fa-search"></i></button>
                </div>
                <div class="user-actions">
                    <a href="#" class="toggle-wishlist" id="toggle-wishlist"><i class="far fa-heart"></i> İstek Listesi</a>
                    <a href="#" class="toggle-cart" id="toggle-cart"><i class="fas fa-shopping-cart"></i> Sepet</a>
                    <a href="#" class="btn login-btn" id="login-btn">Giriş Yap</a>
                </div>
            </div>
        </div>
        <nav class="nav-main">
            <div class="container">
                <ul class="nav-list">
                    <li><a href="index.html" class="nav-home">Ana Sayfa</a></li>
                    <li>
                        <a href="#">Kategoriler <i class="fas fa-chevron-down"></i></a>
                        <div class="dropdown">
                            <a href="category.html?category=elektronik" class="category-link" data-category="elektronik">Elektronik</a>
                            <a href="category.html?category=giyim" class="category-link" data-category="giyim">Giyim</a>
                            <a href="category.html?category=ev-yasam" class="category-link" data-category="ev-yasam">Ev & Yaşam</a>
                            <a href="category.html?category=kozmetik" class="category-link" data-category="kozmetik">Kozmetik</a>
                            <a href="category.html?category=kitap" class="category-link" data-category="kitap">Kitap, Müzik, Film</a>
                        </div>
                    </li>
          
                </ul>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container checkout-page">
            <h1 class="section-title">Ödeme</h1>
            <div class="checkout-container">
                <div class="checkout-form">
                    <h2>Teslimat Bilgileri</h2>
                    <form id="checkout-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="checkout-name">Ad</label>
                                <input type="text" id="checkout-name" required>
                            </div>
                            <div class="form-group">
                                <label for="checkout-surname">Soyad</label>
                                <input type="text" id="checkout-surname" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="checkout-email">E-posta</label>
                            <input type="email" id="checkout-email" required>
                        </div>
                        <div class="form-group">
                            <label for="checkout-phone">Telefon</label>
                            <input type="tel" id="checkout-phone" required>
                        </div>
                        <div class="form-group">
                            <label for="checkout-address">Adres</label>
                            <input type="text" id="checkout-address" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="checkout-city">İl</label>
                                <input type="text" id="checkout-city" required>
                            </div>
                            <div class="form-group">
                                <label for="checkout-district">İlçe</label>
                                <input type="text" id="checkout-district" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="checkout-zip">Posta Kodu</label>
                            <input type="text" id="checkout-zip" required>
                        </div>
                        
                        <h2>Ödeme Bilgileri</h2>
                        <div class="payment-methods">
                            <div class="payment-method active">
                                <div class="payment-method-header">
                                    <input type="radio" name="payment" id="credit-card" class="payment-method-radio" checked>
                                    <label for="credit-card">Kredi Kartı</label>
                                </div>
                                <div class="payment-method-info">
                                    <div class="form-group">
                                        <label for="card-number">Kart Numarası</label>
                                        <input type="text" id="card-number" placeholder="1234 5678 9012 3456">
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="card-expire">Son Kullanma Tarihi</label>
                                            <input type="text" id="card-expire" placeholder="MM/YY">
                                        </div>
                                        <div class="form-group">
                                            <label for="card-cvv">CVV</label>
                                            <input type="text" id="card-cvv" placeholder="123">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="card-name">Kart Üzerindeki İsim</label>
                                        <input type="text" id="card-name">
                                    </div>
                                </div>
                            </div>
                            <div class="payment-method">
                                <div class="payment-method-header">
                                    <input type="radio" name="payment" id="bank-transfer" class="payment-method-radio">
                                    <label for="bank-transfer">Banka Havalesi</label>
                                </div>
                                <div class="payment-method-info">
                                    <p>Siparişinizi verdikten sonra banka hesap bilgilerimiz e-posta adresinize gönderilecektir. Ödemenizi yaptıktan sonra siparişiniz hazırlanacaktır.</p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="checkout-summary">
                    <h2>Sipariş Özeti</h2>
                    <div class="checkout-products" id="checkout-products">
                        <!-- Products will be loaded here -->
                    </div>
                    <div class="checkout-total">
                        <div class="checkout-total-row">
                            <span>Ara Toplam</span>
                            <span id="subtotal">0,00 ₺</span>
                        </div>
                        <div class="checkout-total-row">
                            <span>Kargo</span>
                            <span id="shipping">0,00 ₺</span>
                        </div>
                        <div class="checkout-total-row">
                            <span>Toplam</span>
                            <span id="total">0,00 ₺</span>
                        </div>
                    </div>
                    <button class="place-order-btn" id="place-order-btn">Siparişi Tamamla</button>
                </div>
            </div>
        </div>
    </main>


    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-grid">
                <div class="footer-column">
                    <h3>DS Shop</h3>
                    <ul class="footer-links">
                        <li><a href="about.html">Hakkımızda</a></li>
                        <li><a href="contact.html">İletişim</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Kategoriler</h3>
                    <ul class="footer-links">
                        <li><a href="category.html?category=elektronik">Elektronik</a></li>
                        <li><a href="category.html?category=giyim">Giyim</a></li>
                        <li><a href="category.html?category=ev-yasam">Ev & Yaşam</a></li>
                        <li><a href="category.html?category=kozmetik">Kozmetik</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>İletişim</h3>
                    <ul class="footer-links">
                        <li><i class="fas fa-map-marker-alt"></i> İstanbul, Türkiye</li>
                        <li><i class="fas fa-phone"></i> +90 212 123 4567</li>
                        <li><i class="fas fa-envelope"></i> info@dsshop.com</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 DS Shop. Tüm hakları saklıdır.</p>
            </div>
        </div>
    </footer>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">İşlem başarıyla tamamlandı!</span>
    </div>

    <script src="script.js"></script>
    <script>
   // Checkout sayfası için eklenen sipariş kaydetme fonksiyonları
document.addEventListener('DOMContentLoaded', function() {
    // Kullanıcı giriş yapmış mı kontrol et
    if (!isLoggedIn) {
        // Giriş yapılmamışsa ana sayfaya yönlendir
        showToast('Ödeme yapmak için giriş yapmanız gerekmektedir!', 'error');
        // Giriş yapıldıktan sonra checkout'a dönmek için bilgi sakla
        sessionStorage.setItem('redirect-to-checkout', 'true');
        setTimeout(function() {
            window.location.href = 'index.html';
        }, 2000);
        return;
    }
    
    // Check if cart is empty
    if (cart.length === 0) {
        // Redirect to home page if cart is empty
        window.location.href = 'index.html';
        return;
    }
    
    // Update checkout summary
    updateCheckoutSummary();
    
    // Payment method selection
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', function() {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            this.classList.add('active');
            this.querySelector('.payment-method-radio').checked = true;
        });
    });
    
    // Place order button
    document.getElementById('place-order-btn').addEventListener('click', function() {
        // Validate form
        const form = document.getElementById('checkout-form');
        if (form.checkValidity()) {
            handlePlaceOrder();
        } else {
            // Show validation messages
            form.reportValidity();
        }
    });
    
    // Pre-fill form with user data if logged in
    if (isLoggedIn) {
        prefillCheckoutForm();
    }
    
    // Sepet ve istek listesi modalları için özel işleyiciler
    setupModalHandlers();
});

function setupModalHandlers() {
    // Cart modal close button
    const cartCloseBtn = document.getElementById('cart-close');
    if (cartCloseBtn) {
        cartCloseBtn.addEventListener('click', function() {
            const cartModal = document.getElementById('cart-modal');
            if (cartModal) {
                cartModal.classList.remove('show');
                
                // Check if any other modal is open
                if (!isAnyModalOpen()) {
                    const overlay = document.getElementById('overlay');
                    if (overlay) overlay.style.display = 'none';
                }
            }
        });
    }
    
    // Wishlist modal close button
    const wishlistCloseBtn = document.getElementById('wishlist-close');
    if (wishlistCloseBtn) {
        wishlistCloseBtn.addEventListener('click', function() {
            const wishlistModal = document.getElementById('wishlist-modal');
            if (wishlistModal) {
                wishlistModal.classList.remove('show');
                
                // Check if any other modal is open
                if (!isAnyModalOpen()) {
                    const overlay = document.getElementById('overlay');
                    if (overlay) overlay.style.display = 'none';
                }
            }
        });
    }
}

function updateCheckoutSummary() {
    const checkoutProductsContainer = document.getElementById('checkout-products');
    checkoutProductsContainer.innerHTML = '';
    
    let subtotal = 0;
    const shipping = cart.length > 0 ? 19.99 : 0;
    
    cart.forEach(item => {
        const product = findProductById(item.id);
        if (product) {
            const itemTotal = product.price * item.quantity;
            subtotal += itemTotal;
            
            const checkoutProductElement = document.createElement('div');
            checkoutProductElement.className = 'checkout-product';
            checkoutProductElement.innerHTML = `
                <div class="checkout-product-img">
                    <img src="${product.image}" alt="${product.name}">
                </div>
                <div class="checkout-product-info">
                    <div class="checkout-product-title">${product.name}</div>
                    <div class="checkout-product-price">${formatPrice(product.price)}</div>
                    <div class="checkout-product-quantity">Adet: ${item.quantity}</div>
                </div>
            `;
            
            checkoutProductsContainer.appendChild(checkoutProductElement);
        }
    });
    
    const total = subtotal + shipping;
    
    document.getElementById('subtotal').textContent = formatPrice(subtotal);
    document.getElementById('shipping').textContent = formatPrice(shipping);
    document.getElementById('total').textContent = formatPrice(total);
}

// Kullanıcı verilerini formdan alıp sipariş nesnesini oluşturan fonksiyon
// Kullanıcı verilerini formdan alıp sipariş nesnesini oluşturan fonksiyon - DÜZELTİLDİ
function collectOrderData() {
    // Form verilerini topla
    const orderData = {
        id: generateOrderNumber(),
        date: new Date().toLocaleDateString('tr-TR'),
        customer: {
            name: document.getElementById('checkout-name').value,
            surname: document.getElementById('checkout-surname').value,
            email: document.getElementById('checkout-email').value,
            phone: document.getElementById('checkout-phone').value,
            address: document.getElementById('checkout-address').value,
            city: document.getElementById('checkout-city').value,
            district: document.getElementById('checkout-district').value,
            zip: document.getElementById('checkout-zip').value
        },
        items: [],
        payment: {
            method: document.querySelector('input[name="payment"]:checked').id, // Burada değişiklik yaptık: value yerine id kullanıyoruz
            cardInfo: null
        },
        subtotal: 0,
        shipping: 19.99,
        total: 0,
        status: 'Hazırlanıyor'
    };

    // Ödeme yöntemi kredi kartı ise kart bilgilerini ekle
    if (orderData.payment.method === 'credit-card') {
        orderData.payment.cardInfo = {
            number: document.getElementById('card-number').value,
            expire: document.getElementById('card-expire').value,
            name: document.getElementById('card-name').value
            // CVV bilgisini güvenlik için saklamıyoruz
        };
    }

    // Sipariş öğelerini ekle
    let subtotal = 0;
    cart.forEach(item => {
        const product = findProductById(item.id);
        if (product) {
            const itemTotal = product.price * item.quantity;
            subtotal += itemTotal;
            
            orderData.items.push({
                id: product.id,
                name: product.name,
                price: product.price,
                quantity: item.quantity,
                total: itemTotal,
                image: product.image
            });
        }
    });
    
    orderData.subtotal = subtotal;
    orderData.total = subtotal + orderData.shipping;
    
    return orderData;
}

// Rastgele sipariş numarası oluşturan yardımcı fonksiyon
function generateOrderNumber() {
    return `DS${Math.floor(10000 + Math.random() * 90000)}`;
}

// Siparişi kullanıcının hesabına kaydeden fonksiyon
function saveOrderToUserAccount(orderData) {
    // Kullanıcı bilgilerini al
    const users = JSON.parse(localStorage.getItem('dsshop-users')) || [];
    const userIndex = users.findIndex(user => user.email === currentUserEmail);
    
    if (userIndex === -1) {
        console.error('Kullanıcı bulunamadı!');
        return false;
    }
    
    // Kullanıcının siparişleri var mı kontrol et, yoksa oluştur
    if (!users[userIndex].orders) {
        users[userIndex].orders = [];
    }
    
    // Siparişi kullanıcının sipariş listesine ekle
    users[userIndex].orders.push(orderData);
    
    // Kullanıcı verilerini localStorage'a kaydet
    localStorage.setItem('dsshop-users', JSON.stringify(users));
    
    return true;
}

// Siparişi tamamlayan ana fonksiyon
function handlePlaceOrder() {
    // 1. Sipariş verilerini topla
    const orderData = collectOrderData();
    
    // 2. Siparişi kullanıcının hesabına kaydet
    const saved = saveOrderToUserAccount(orderData);
    
    if (saved) {
        // 3. Sepeti temizle
        cart = [];
        saveCartToStorage();
        
        // 4. Başarı sayfasına yönlendir
        window.location.href = `order-success.html?order=${orderData.id}`;
    } else {
        showToast('Sipariş kaydedilirken bir hata oluştu!', 'error');
    }
}

function prefillCheckoutForm() {
    // Kullanıcı bilgilerini formdaki alanlara doldur
    const users = JSON.parse(localStorage.getItem('dsshop-users')) || [];
    const email = localStorage.getItem('dsshop-email');
    
    if (email) {
        const user = users.find(u => u.email === email);
        if (user) {
            document.getElementById('checkout-name').value = user.name || '';
            document.getElementById('checkout-surname').value = user.surname || '';
            document.getElementById('checkout-email').value = user.email || '';
            document.getElementById('checkout-phone').value = user.phone || '';
            
            // Kullanıcının kayıtlı adres bilgilerini de doldur (eğer varsa)
            if (user.address) {
                document.getElementById('checkout-address').value = user.address || '';
                document.getElementById('checkout-city').value = user.city || '';
                document.getElementById('checkout-district').value = user.district || '';
                document.getElementById('checkout-zip').value = user.zip || '';
            }
        }
    }
}
    </script>
</body>
</html>
